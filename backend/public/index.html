<!DOCTYPE html>
<html lang="lt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Prisijungimas</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <style>
    #registerForm, #workForm, #editWorkForm, #searchForm, #logoutButton, #workList {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="form-container" id="authForms">
      <form id="loginForm" method="post" action="/login">
        <h3>Prisijungimas</h3>
        <label for="loginUsername">Vartotojas:</label>
        <input type="text" id="loginUsername" name="username" required>
        <label for="loginPassword">Slaptažodis:</label>
        <input type="password" id="loginPassword" name="password" required>
        <button type="submit">Prisijungti</button>
        <p>Neturite paskyros? Registruokitės <a href="#" id="showRegisterForm">čia</a>.</p>
      </form>
      <form id="registerForm">
        <h3>Registracija</h3>
        <label for="registerUsername">Vartotojas:</label>
        <input type="text" id="registerUsername" name="username" required>
        <label for="registerPassword">Slaptažodis:</label>
        <input type="password" id="registerPassword" name="password" required>
        <button type="submit">Registruotis</button>
        <p>Turite paskyrą? Prisijunkite <a href="#" id="showLoginForm">čia</a>.</p>
      </form>
    </div>
    <div id="formsRow" class="row-container">
      <div id="workForm" class="form-container">
        <form id="addWorkForm" method="post" action="works" enctype="multipart/form-data">
          <h3>Pridėti darbą</h3>
          <label for="workTitle">Pavadinimas:</label>
          <input type="text" id="workTitle" name="title" required>
          <label for="description">Aprašymas:</label>
          <textarea id="description" name="description" required></textarea>
          <label for="photo">Nuotrauka</label>
          <input type="file" id="photo" name="photo" required>
          <button type="submit">Pridėti darbą</button>
          <p id="formMessage"></p>
        </form>
      </div>
      <div id="editWorkForm" class="form-container">
        <form id="editForm" method="post" action="works" enctype="multipart/form-data">
          <h3>Redaguoti darbą</h3>
          <input type="hidden" id="editWorkId" name="workId">
          <label for="editWorkTitle">Pavadinimas:</label>
          <input type="text" id="editWorkTitle" name="title" required>
          <label for="editDescription">Aprašymas:</label>
          <textarea id="editDescription" name="description" required></textarea>
          <label for="editPhoto">Nuotrauka</label>
          <input type="file" id="editPhoto" name="photo">
          <button type="submit">Išsaugoti</button>
          <p id="editFormMessage"></p>
        </form>
      </div>
      <div id="searchAndWorkListContainer" class="search-and-worklist-container">
        <div id="searchForm" class="search-form-container">
          <h3>Paieška</h3>
          <div class="search-group">
            <input type="text" id="search" name="search" placeholder="Ieškoti...">
            <button type="button" onclick="searchWorks()">Ieškoti</button>
          </div>
        </div>
        <div id="workList" class="work-list-container">
          <h3>Rastas darbas</h3>
          <!-- Čia bus rodomi darbų sąrašas -->
        </div>
      </div>
    </div>
    <button id="logoutButton">Atsijungti</button>
  </div>
  <script>
    function searchWorks() {
      const searchQuery = document.getElementById('search').value.toLowerCase();

      fetch(`/works`, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      })
      .then(response => response.json())
      .then(data => {
        const workList = document.getElementById('workList');
        workList.innerHTML = '';

        const filteredWorks = data.filter(work => 
          work.title.toLowerCase().includes(searchQuery) ||
          work.description.toLowerCase().includes(searchQuery)
        );

        if (filteredWorks.length > 0) {
          document.getElementById('workList').style.display = 'block';
          filteredWorks.forEach(work => {
            const workItem = document.createElement('div');
            workItem.className = 'work-item';
            workItem.innerHTML = `
              <h4>${work.title}</h4>
              <p>${work.description}</p>
              <img src="/uploads/${work.photo}" alt="${work.title}">
              <button onclick="editWork(${work.id})">Redaguoti</button>
              <button onclick="deleteWork(${work.id})">Ištrinti</button>
            `;
            workList.appendChild(workItem);
          });
        } else {
          document.getElementById('workList').style.display = 'none';
          const noResult = document.createElement('p');
          noResult.textContent = 'Nerasta darbų pagal paiešką.';
          workList.appendChild(noResult);
        }
      })
      .catch(error => console.error('Klaida:', error));
    }

    function editWork(id) {
      fetch(`/works/${id}`, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      })
      .then(response => response.json())
      .then(work => {
        document.getElementById('editWorkId').value = work.id;
        document.getElementById('editWorkTitle').value = work.title;
        document.getElementById('editDescription').value = work.description;
        document.getElementById('editWorkForm').style.display = 'block';
        document.getElementById('workForm').style.display = 'none';
      })
      .catch(error => console.error('Klaida:', error));
    }

    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('showRegisterForm').addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('registerForm').style.display = 'block';
      });

      document.getElementById('showLoginForm').addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('registerForm').style.display = 'none';
        document.getElementById('loginForm').style.display = 'block';
      });

      document.getElementById('loginForm').addEventListener('submit', function(event) {
        event.preventDefault();
        const username = document.getElementById('loginUsername').value;
        const password = document.getElementById('loginPassword').value;

        fetch('/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ username, password })
        })
        .then(response => response.json())
        .then(data => {
          if (data.token) {
            localStorage.setItem('token', data.token);
            document.getElementById('authForms').style.display = 'none';
            document.getElementById('workForm').style.display = 'block';
            document.getElementById('searchForm').style.display = 'block';
            document.getElementById('workList').style.display = 'block';
            document.getElementById('logoutButton').style.display = 'block';

            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
          } else {
            alert('Neteisingi prisijungimo duomenys');
          }
        })
        .catch(error => console.error('Klaida:', error));
      });

      document.getElementById('registerForm').addEventListener('submit', function(event) {
        event.preventDefault();
        const username = document.getElementById('registerUsername').value;
        const password = document.getElementById('registerPassword').value;

        fetch('/register', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ username, password })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            document.getElementById('registerForm').reset();
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
          } else {
            alert('Registracijos klaida');
          }
        })
        .catch(error => console.error('Klaida:', error));
      });

      document.getElementById('logoutButton').addEventListener('click', function() {
        localStorage.removeItem('token');
        document.getElementById('authForms').style.display = 'block';
        document.getElementById('workForm').style.display = 'none';
        document.getElementById('searchForm').style.display = 'none';
        document.getElementById('workList').style.display = 'none';
        document.getElementById('logoutButton').style.display = 'none';
      });
    });
  </script>
</body>
</html>
